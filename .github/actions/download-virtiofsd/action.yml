name: Download virtiofsd
description: Download virtiofsd binary and cache it using GitHub's default cache eviction policy (currently 7 days)

inputs:
  prime-cache-only:
    description: 'Set to true to only populate cache on miss without restoring files. When false (default), cache will be restored if available.'
    default: false
    required: false
    type: boolean

runs:
  using: composite
  steps:
    - name: virtiofsd cache key
      id: virtiofsd-cache-key
      shell: bash
      run: |
        set -eux
        ARCH="$(dpkg --print-architecture)"

        # To download the binaries for the right arch.
        echo "ARCH=${ARCH}" >> $GITHUB_OUTPUT

        # i.e: virtiofsd-amd64
        echo "KEY=virtiofsd-${ARCH}" >> $GITHUB_OUTPUT

    # GitHub will remove any cache entries that have not been accessed in over 7 days.
    # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/caching-dependencies-to-speed-up-workflows#usage-limits-and-eviction-policy
    - name: Cache virtiofsd binary
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      id: cache-virtiofsd
      with:
        path: |
          /home/runner/go/bin/virtiofsd
        key: ${{ steps.virtiofsd-cache-key.outputs.KEY }}
        # Some jobs only want to prime the cache if not populated already.
        # Those jobs don't need the files otherwise so they should not restore
        # from the cache.
        lookup-only: ${{ inputs.prime-cache-only }}

    - name: Download virtiofsd
      if: ${{ steps.cache-virtiofsd.outputs.cache-hit != 'true' }}
      env:
        ARCH: ${{ steps.virtiofsd-cache-key.outputs.ARCH }}
      shell: bash
      run: |
        set -eux

        if grep -qxF 'VERSION_ID="22.04"' /etc/os-release; then
          echo "::notice::actions/download-virtiofsd should not be used on 22.04, use the apt package 'virtiofsd' instead."
        fi

        . test/includes/setup.sh
        download_virtiofsd "/home/runner/go/bin"
